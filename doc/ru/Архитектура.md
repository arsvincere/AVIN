# Архитектура

## Модули
- data - работа с историческими данными
- core - слой абстракций для работы с данными на "трейдерском" языке
- research - инструментарий для анализа данных и составления стратегий
- tester - просто бэктестер
- sandbox - интерфейс как у боевого модуля, но работает в песочнице Тинькофф
- general - управление роботами в боевом режиме
- terminal - простой терминал, возможность ручного управления на всякий случай
- report - построение отчетов
- informer - уведомления

Вспомогательные модули
- connect - подключения к брокерам и источникам данных
- utils - вспомогательные утилиты для работы системы
- const - константы и настройки пользователя

__Обоснование архитектуры__
Каждый модуль соответствует одной части работы трейдера. Я как трейдер собираю данные, затем анализирую и вырабатываю торговую гипотезу, потом прикидываю как она отрабатывала в прошлом, потом пытаюсь так торговать, потом подвожу итоги. И время от времени настраиваю уведомления в трейдинг-вью. Каждый модуль программы берет на себя одну часть работы.

### Data<!--{{{-->
Все для работы с данными: инструменты для скачивания, преобразования, упорядочивания и хранения данных. Обновление биржевых данных. Загрузка данных за произвольный период (по годам). Поиск активов по тикеру. Подробная информация по активу.

##### Progress
- [х] Выбор пользователем источника данных
- [х] Выбор активов (индексы, акции, облигации, фьючерсы, валюты, ETF)
- [х] Выбор периода
- [x] загрузка и преобразование данных с Мос Биржи
- [x] загрузка и преобразование данных Тинькофф брокера
- [x] раскладывание данных по папкам:
      USR_DIR/data/<exchenge>/<type>/<ticker>/<data_type>/year.csv
- [x] обновление данных через Тинькофф (задержка от 10сек до 2мин)
- [x] обновление данных через MOEX (задержка от 1мин до 15мин)
- [ ] Запись и сохранение истории стаканов
- [ ] Запись и сохранение потока сделок
- [ ] Преобразование в крупные таймфреймы квартальный, годовой

<!--}}}-->
### Research <!--{{{-->
Все что нужно для составления стратегии.

##### Progress
- [x] Просмотр исторических графиков
- [x] Нанесение на них индикаторов
- [x] Написание любых алгоритмов по обработке данных
- [x] В тестах, песочнице и реалтайме, через класс Analytic предоставляется
      доступ к этим данным.
- [x] Написание пользовательский скриптов по обработке данных
- [x] Динамический импорт, возможность запуска пользовательских скриптов в
      любой период во время работы тестера, песочницы или в боевом режиме
- [x] Написание условий, динамическая загрузка условий
- [ ] Группировка условий в составные фильтры с логическими операторами:
      condition-1 and condition-2 or condition-3
- [ ] Добавление графических меток по заданным условиям
- [ ] Просмотр стаканов
- [ ] Просмотр потока сделок
- [ ] Инструменты комбинаторики для простой работы с проверкой разных
      комбинаций условий входа, размеров стопа и тейка и тп.
<!--}}}-->
### Tester<!--{{{-->
Бэк тестер.

##### Progress
- [x] Создание теста
    - [x] выбор названия теста
    - [x] выбор стратегии
    - [x] выбор активов
    - [x] выбор размера стартового депозита
    - [x] выбор периода
    - [x] выбор таймфрейма
    - [x] запись примечаний по тесту
- [x] Выполнение теста
    - [х] Загрузка данных по активу
    - [х] Передача данных стратегии по заданному шагу (1мин, 5мин и тп)
    - [х] Получение сигналов от стратегии
    - [х] Выставление ордеров
    - [х] Мониторинг открытых позиций
    - [х] Закрытие позиции и сохранение информации о сделке
- [x] Редактирование теста
- [x] Просмотр результатов теста
    - [x] Саммари по сделкам.
    - [x] Просмотр совершенных сделок на графике.
    - [x] Просмотр подробных сведений о сделке.
- [ ] Возможно форк бэктестера
- [ ] Расчет и построение кривой капитала
- [ ] Вычисления классических коэффициентов оценки стратегии:
      - [ ] коэффициент Шарпа
      - [ ] коэффициент Сортино
- [ ] Визуализации графики - более симпатичный вид отчета, пока просто csv
<!--}}}-->
### Sandbox<!--{{{-->
Запуск сконфигурированных и протестированных стратегий в песочницу - симуляции работы в реалтайме на виртуальном счете.

##### Progress 
- [x] Подключение к брокеру Тинькофф
- [x] Открытие, закрытие, добавление денег на виртуальный счет
- [x] Выставление ордеров
- [x] Получение списка выставленных ордеров
- [x] Получение списка операций
- [x] Получение списка открытых позиций и кэша
- [x] Получение реалтайм потока
- [x] Асинхронная работа системы:
    - [х] получение рыночного события - новая свеча
        - [x] передача новых свеч стратегиям 
        - [x] прием сигналов от стратегий
        - [x] обработка сигналов и выставление ордеров по ними
    - [ ] получение рыночного события - ордер выставлен
    - [ ] получение рыночного события - ордер исполнен
    - [ ] получение рыночного события - операция выполнена
    - [ ] получение рыночного события - позиция закрыта
    - [ ] запись истории сделок
- [ ] GUI настройка параметров работы: выбор брокера, счета,
    расписания работы, настройка риска.
- [ ] GUI мониторинг работы системы
    - [ ] отображение активного подключения
    - [ ] отображение получения данных
    - [ ] отображение сигналов
        - [ ] отображение ордеров выставленных по сигналу
        - [ ] отображение позиции открытой по сигналу
        - [ ] отображение операций связанных с этой позицией
<!--}}}-->
### General<!--{{{-->
Запуск стратегий в боевом режиме

##### Progress 
- [ ] Настройка параметров работы:
    - [ ] выбор брокера
    - [ ] выбор счета
    - [ ] расписания работы
    - [ ] список активов
    - [ ] список стратегий
    - [ ] настройка риска
- [ ] Подключение к брокеру Алор
- [ ] Подключение к брокеру Финам
- [ ] Подключение к криптобиржам
<!--}}}-->
### Terminal<!--{{{-->
Возможность ручного управления, полноценный терминал.
- [х] выставление ордеров
- [х] получение списка выставленных ордеров
- [х] получение списка операций
- [х] получение списка позиций
- [х] получение подробной информации по портфелю
<!--}}}-->
### Report<!--{{{-->
Всевозможные отчеты, инструменты для анализа статистики торговли. 

##### Progress 
- [ ] Перевод списка json в базу данных совершенных сделок
- [ ] Построение отчетов по дням, неделям, месяцам, кварталам, годам.
    - [ ] Просмотр отчетов в приложении
    - [ ] Экспорт в PDF
- [ ] Разрезы по стратегиям, трейдерам, активам, секторам, биржам и тп.
- [ ] Селекты прошлых сделок по любым критериям.
- [ ] Атоматическая отправка отчетов в телеграмм или на почту
<!--}}}-->
### Informer<!--{{{-->
Отправка уведомлений в телеграмм или на почту

##### Progress 
- [ ] обдумать

<!--}}}-->

## Организация данных<!--{{{-->

### avin<!--{{{-->
    Исходный код
<!--}}}-->
### doc <!--{{{-->
    Документация.
    Общая архитектура и принципы работы описаны на русском и продублированы
    на английском.
    Документация в коде по функция и классам - только на английском. На
    примитивном английском, так что гугл переводчик выдает весьма точный 
    перевод.
<!--}}}-->
### env<!--{{{-->
    Python окружение программы
<!--}}}-->
### lang<!--{{{-->
    Файлы локализации.
    Я пишу интерфейс программы полностью на английском, с использованием 
    библиотеки GNU gettext. Кому надо - переводите. Постараюсь содействовать.
<!--}}}-->
### log <!--{{{-->
    Логи.
    debug.log - перезаписывается при каждом запуске. Именно этот файл мне
    нужно отправлять, если обнаружили какую-то ошибку. Непосредственно 
    после возникновения ошибки.
    <date>.log - логи уровня [info] и выше. Дозаписываются при каждом запуске.
    По умолчанию хранится последния пять файлов лога, включая файл debug.log 
<!--}}}-->
### res <!--{{{-->
    ресурсы программы - кэш, иконки и тп.
<!--}}}-->
### test<!--{{{-->
    Тесты pytest
<!--}}}-->
### tmp <!--{{{-->
    Временные файлы
<!--}}}-->
### usr<!--{{{-->
Папка со всеми данными пользователя. Бэкапить ее. Остальное внутренняя
кухня системы, изучение которой не требуется для работы с системой.

По умолчанию папка расположена в корне программы ./usr
Но можно указать абсолютный путь в любое другое место, см. модуль const.py

### usr subdirectories
#### analytic
    Скрипты, программы пользователя по анализу данных
	<research-1.py>
	<research-2.py>

#### asset
    Списки активов
	<list_name.al> // json

#### condition
    Условия, функции которые принимают актив, что-то в нем смотрят и
    возвращают True/False.
    <condition-1.py>
    <condition-2.py>
    <condition-3.py>

#### connect
    Логины пароли, токены для подключения к брокерам
	name
		<token.txt>

#### data 
    Пользовательски данные, в стандартизированном формате
	1M - минутный таймфрейм
		<asset> // json
		<timeframe> // txt
		<year.csv>
	5M - таймфрейм 5М
	10M - ...
	1H - ...
	D - ...
	W - ... 
	M - ...
    book - стаканы
    tic - тики
	analyse - папка с результатами работы пользовательского анализа данных
        файлы из нее могут быть динамически подгружены для работы стратегий
		<name.a> // json

#### download
    Загруженные данные, в формате как есть у поставщика данных
    exchange
        asset_type
            <datafiles>

#### filter
    Фильтр это комбинация условий (condition)
	<name-1.json>
	<name-2.json>
    ...

#### general
    Настройки работы роботов (в разработке)
    <?????????>  // toml??

#### journal
    История всех сделок в боевом режиме
	<MYSQL>

#### marker
    Это фильтр + графический значок и цвет. Может быть нанесен на график
    где выполняется условия фильтра. Суть: вырабатываем гипотезу, пишем
    услвия (condition), пишем комбинации условий (filter). Наносим их на
    график, смотрим что получается. Если закономерность найдена - пихаем 
    уже готовые фильтры в стратегию (чтобы не переписывать код) и проверяем
    тестером.
	<name-1.json>
	<name-2.json>
	<name-3.json>

#### sandbox
    Тоже что и general но в песочнице
        <?????????>

#### settings
    Настройки пользовательского интерфейса

#### strategy
    Пользовательские стратегии. Динамическая загрузка.
    name
        <version.py> // код стратегии
        <long.al>  // список активов торгующихся в лонг
        <short.al>  // список активов торгующихся в шорт

#### test
	<config.cfg> // json настройки теста - период, стратегия и тп.
	<alist.al> // json - список тестируемых активов 
	<tlist.tl> // json - список совершенных сделок
	<report.csv> - сводка по сделкам
<!--}}}-->
<!--}}}-->
## Обработка ошибок<!--{{{-->

Система старается не падать, никому не понравится аварийное завершение 
программы из какой то фигни во время работы роботов. Поэтому программа
всегда только выводит сообщения об ошибках, отменяет операцию или возвращает
пустой результат в случае некорретных данных, или всяких нештатных ситуациях.

Ошибки выводятся в стрим лог. Дублируются в файлы логов. В гуи сообщения 
логгера уровня [warning] и выше выводятся в диалоговые окна.
<!--}}}-->
## Выбор языка программирования<!--{{{-->

Python - основная часть программы. Гибкий, высокоуровневый. Большое
количество библиотек для работы с данными.

PyQt - Кроссплатформенность. GUI без гемороя по стыковке двух языков
программирования.

С++ Qt - запасной вариант, возможно переделывать гуи если производительности
окажется недостаточно. Возможно понадобится переписать только один модуль -
график. Остальное питон точно тянет нормально.

С - высоконагруженные части программы, ресурсоемкие вычисления.
<!--}}}-->
## Тестирование<!--{{{-->

pytest
Полное покрытие открытого интерфейса классов.
Закрытые функции обычно не тестируются, и часто меняются.
<!--}}}-->
## Контроль версий<!--{{{-->

git
<!--}}}-->
## Репозитарий проекта<!--{{{-->

http://github.com/arsvincere/AVIN
<!--}}}-->
## Сайт<!--{{{-->

http://arsvincere.com
<!--}}}-->

